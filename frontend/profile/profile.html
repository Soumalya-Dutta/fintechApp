<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Profile â€” FintechApp</title>
  <link rel="stylesheet" href="../assets/styles.css">
  <style>
    .profile-hero{background:linear-gradient(135deg, #93009c 0%, #6b0078 100%);color:#fff;padding:30px;border-radius:12px;margin-bottom:24px;text-align:center}
    .profile-hero h1{color:#fff;margin:0 0 8px}
    .profile-hero p{margin:0;color:rgba(255,255,255,0.9)}
    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:linear-gradient(135deg, #b000b2 0%, #93009c 100%);color:#fff;padding:20px;border-radius:10px;text-align:center;box-shadow:var(--shadow)}
    .stat-card h3{margin:0 0 8px;font-size:0.95em;opacity:0.9}
    .stat-card .value{font-size:2em;font-weight:700}
    .section-card{background:#1a1a1a;padding:24px;border-radius:12px;margin-bottom:20px;box-shadow:var(--shadow)}
    .section-card h2{color:#b000b2;margin-top:0;border-bottom:2px solid #380356;padding-bottom:12px}
    .kyc-section{background:#380356;padding:20px;border-radius:10px;border-left:4px solid #b000b2}
    .action-buttons{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px}
    .action-link{display:inline-block;padding:10px 16px;background:linear-gradient(135deg, #93009c 0%, #6b0078 100%);color:#fff;text-decoration:none;border-radius:8px;font-weight:500;transition:all 0.3s}
    .action-link:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .action-link.secondary{background:linear-gradient(135deg, #380356 0%, #6b0078 100%)}
    .info-box{display:block;text-decoration:none;background:#2a2a2a;border:2px solid #380356;border-radius:10px;padding:16px;transition:all 0.2s}
    .info-box:hover{border-color:#b000b2;transform:translateY(-2px)}
    .info-box-title{color:#b000b2;font-weight:700;margin:0 0 10px}
    .info-box-row{color:#ffffff;margin:6px 0;font-size:0.95em;word-break:break-word}
    .info-box-hint{color:#aaaaaa;font-size:0.88em;margin-top:10px}
  </style>
</head>
<body>
  <header>
    <div style="text-align:center;padding:8px 16px;">
      <h1 style="margin:0;font-size:1.3em;font-weight:700;color:#fff;">FintechApp</h1>
    </div>
  </header>

  <main style="margin-top: 40px;">
    <div class="profile-hero">
      <h1>My Profile</h1>
      <p>Manage your account and complete verification</p>
    </div>

    <div class="dashboard-grid">
      <div class="stat-card">
        <h3>Account Status</h3>
        <div class="value">Active</div>
      </div>
      <div class="stat-card">
        <h3>KYC Status</h3>
        <div id="kycStatusBadge" class="value">Pending</div>
      </div>
      <div class="stat-card">
        <h3>Transactions</h3>
        <div class="value" id="txnCount">0</div>
        <button onclick="loadTransactionCount()" style="margin-top:8px;padding:6px 12px;background:rgba(255,255,255,0.2);border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:0.85em">Refresh</button>
      </div>
    </div>

    <div class="section-card">
      <h2>Basic Information</h2>
      <a href="./basic-info.html" class="info-box" aria-label="Open basic information details page">
        <p class="info-box-title">View and Edit Details</p>
        <p class="info-box-row"><strong>Name:</strong> <span id="previewName">-</span></p>
        <p class="info-box-row"><strong>Email:</strong> <span id="previewEmail">-</span></p>
        <p class="info-box-row"><strong>Phone:</strong> <span id="previewPhone">-</span></p>
        <p class="info-box-hint">Click this box to open details and edit basic information.</p>
      </a>
    </div>

    <div class="section-card">
      <h2>KYC Verification</h2>
      <div class="kyc-section">
        <p><strong>Status:</strong> <span id="kycStatus" class="badge pending">Checking...</span></p>
        <p id="kycMsg" style="margin:8px 0 0">Loading KYC status...</p>
      </div>
      <div class="action-buttons" style="margin-top:16px">
        <a href="../kyc/kyc-upload.html" class="action-link secondary">Upload Documents</a>
        <a href="../transactions/transactions.html" class="action-link secondary">View Transactions</a>
      </div>
    </div>
  </main>

  <footer>
    <small>Your data is secure and encrypted | <a href="#" style="color:#b000b2;text-decoration:none">Privacy</a> | <a href="#" style="color:#b000b2;text-decoration:none">Terms</a></small>
  </footer>

  <script>
    const kycStatus = document.getElementById('kycStatus');
    const kycMsg = document.getElementById('kycMsg');

    function setPreview(user) {
      document.getElementById('previewName').textContent = user.fullname || '-';
      document.getElementById('previewEmail').textContent = user.email || '-';
      document.getElementById('previewPhone').textContent = user.phone || '-';
    }

    async function loadBasicPreview() {
      const userId = localStorage.getItem('userId');
      if (!userId) {
        setPreview({
          fullname: localStorage.getItem('fullname') || '',
          email: localStorage.getItem('email') || '',
          phone: localStorage.getItem('phone') || ''
        });
        return;
      }

      try {
        const response = await fetch(`/api/auth/profile/${encodeURIComponent(userId)}`);
        const data = await response.json();
        if (response.ok && data.user) {
          setPreview(data.user);
          localStorage.setItem('fullname', data.user.fullname || '');
          localStorage.setItem('email', data.user.email || '');
          localStorage.setItem('phone', data.user.phone || '');
          return;
        }
      } catch (err) {
        console.error('Preview load from API failed:', err);
      }

      setPreview({
        fullname: localStorage.getItem('fullname') || '',
        email: localStorage.getItem('email') || '',
        phone: localStorage.getItem('phone') || ''
      });
    }

    async function loadKYCStatus() {
      try {
        const userId = localStorage.getItem('userId') || 'user123';
        const response = await fetch(`/api/kyc/${userId}/status`);
        const data = await response.json();
        if (data.status) {
          const statusText = data.status.toUpperCase();
          kycStatus.textContent = statusText;
          kycStatus.className = `badge ${data.status}`;
          document.getElementById('kycStatusBadge').textContent = statusText;
          kycMsg.textContent = `Status: ${statusText}. Last updated: ${new Date(data.record?.createdAt).toLocaleDateString() || 'Never'}`;
        }
      } catch (err) {
        kycMsg.textContent = 'Could not load KYC status';
      }
    }

    async function loadTransactionCount() {
      try {
        const response = await fetch('/api/transfers/history');
        const data = await response.json();
        if (data.ok && data.transactions) {
          document.getElementById('txnCount').textContent = data.transactions.length;
        }
      } catch (err) {
        console.error('Error loading transaction count:', err);
        document.getElementById('txnCount').textContent = '0';
      }
    }

    loadBasicPreview();
    loadKYCStatus();
    loadTransactionCount();

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        loadTransactionCount();
        loadBasicPreview();
      }
    });

    window.addEventListener('focus', () => {
      loadTransactionCount();
      loadBasicPreview();
    });
  </script>
</body>
</html>
